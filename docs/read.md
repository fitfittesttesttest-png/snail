-----

#  ECサイトの商品購入（決済画面）設計書

## 概要

ユーザーがカートに入れた商品を購入するための決済機能と、最終的な注文内容の確認を行う画面の設計。特定商取引法に基づく最終確認画面としての機能も兼ねる。

-----

## 画面イメージ

### 構成要素

1.  **配送情報入力エリア**: 配送先住所、郵便番号、氏名、電話番号など。
2.  **注文内容確認エリア**: 商品リスト、小計、送料、手数料、合計金額。
3.  **決済方法選択・入力エリア**: 決済方法の選択と、選択に応じた詳細情報入力欄（カード情報、その他）。
4.  **プロモーションコード/ポイント利用エリア**: 割引コードやポイントの入力/利用設定欄。
5.  **「注文確定」ボタン**。
6.  **注意事項/特商法に基づく表示へのリンク**。

-----

## 項目設計

| 項目名 | I/O | データ型 | 制約 | 備考 |
| :--- | :--- | :--- | :--- | :--- |
| **配送先氏名** | I | String | **必須**、最大50文字 | |
| **配送先電話番号** | I | String | **必須**、半角数字10桁または11桁、ハイフン不可 | |
| **配送先住所** | I | String | **必須**、最大100文字、住所形式 | |
| **郵便番号** | I | String | **必須**、ハイフンなし7桁の半角数字 | |
| **注文内容（明細）** | O | Array | **必須**、商品名、単価、数量、小計を含む | |
| **小計金額** | O | Integer | **必須**、非負の整数 | |
| **送料** | O | Integer | **必須**、非負の整数 | |
| **手数料（代金引換など）** | O | Integer | 決済方法による、非負の整数 | |
| **合計請求金額** | O | Integer | **必須**、小計＋送料＋手数料−割引額 | |
| **決済方法** | I | String | **必須**、選択形式（クレジットカード/銀行振込/代金引換/その他） | |
| **カード番号** | I | String | 決済方法が「クレジットカード」の場合**必須**、14桁〜16桁の半角数字、ハイフン不可 | |
| **有効期限（月/年）** | I | String | 決済方法が「クレジットカード」の場合**必須**、MM/YY形式、**過去の日付不可** | |
| **セキュリティコード** | I | String | 決済方法が「クレジットカード」の場合**必須**、3桁または4桁の半角数字 | |
| **プロモーションコード** | I | String | 任意、最大20文字、英数記号 | 適用された場合、割引額が計算される |
| **利用ポイント** | I | Integer | 任意、**最大保有ポイント数以内**、1ポイント＝1円 | |

-----

## 動作一覧

| 動作名 | 説明 | トリガー | 処理内容 | 成功時の挙動 | 失敗時の挙動 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **入力内容のリアルタイム検証** | ユーザーが決済に必要な情報を入力した際にリアルタイムで検証を実施する。 | ・入力欄への文字入力<br>・フォーカス移動 | 住所/郵便番号/氏名/電話番号: 必須チェック、形式チェック<br>カード情報: 必須チェック、桁数チェック、有効期限チェック（当月以降か） | 入力欄の下にエラー表示なし。 | エラーメッセージを入力欄下に表示し、該当入力欄を**赤枠で強調**。 |
| **郵便番号からの住所自動入力** | 郵便番号入力後、住所を自動で検索し、入力欄に反映する。 | 郵便番号が7桁で入力完了（フォーカスアウト時） | 郵便番号から住所データを検索し、該当入力欄に自動入力。 | 住所欄に検索結果を反映。ユーザーは確認・修正可能。 | 住所欄は空のまま。エラー表示なし。 |
| **支払い方法による項目切り替え** | ユーザーが支払い方法を選択した際に、関連する入力項目を表示/非表示にする。 | 決済方法のドロップダウン選択 | 選択値が「クレジットカード」の場合: カード情報欄を**表示**<br>選択値が「代金引換」の場合: 手数料を表示<br>それ以外: カード情報欄を**非表示** | 適切な入力項目が表示または非表示となる。 | N/A |
| **プロモーションコード適用** | ユーザーがコードを入力し「適用」ボタンをクリックすることで割引を計算し、合計金額に反映する。 | プロモーションコード入力後の「適用」ボタンクリック | コードの有効性（存在、期間、利用条件）を検証し、有効であれば割引額を計算。 | 注文内容確認エリアの割引額と合計請求金額を更新。成功メッセージを表示。 | エラーメッセージ（例: 「コードが無効です」「期限切れです」）を表示し、割引額は0のまま。 |
| **利用ポイント計算** | 利用ポイントを入力し、合計金額に反映する。 | 利用ポイント入力欄の値変更（フォーカスアウト時） | 入力値が保有ポイントを超えていないか検証し、超えていなければ合計請求金額から差し引く。 | 注文内容確認エリアの割引額と合計請求金額を更新。 | エラーメッセージ（例: 「利用可能ポイントを超えています」）を表示し、合計金額は再計算せず元のまま。 |
| **注文確定ボタンの状態切り替え** | すべての必須項目（選択された決済方法に応じたカード情報も含む）に有効な値が入力された場合に「注文確定ボタン」を有効化する。 | 入力欄の値が変更されたとき | すべての必須項目が**有効**な場合: ボタン有効化<br>一つでも**無効**な場合: ボタン無効化 | ボタンがクリック可能となる。 | ボタンが**非活性状態**となる。 |
| **注文確定処理** | ユーザーが「注文確定ボタン」をクリックした際に、注文および決済処理を実施する。 | 注文確定ボタンクリック | 1. **最終バリデーション**（サーバーサイド）<br>2. **在庫確保**（仮予約）<br>3. **決済処理**（与信枠確保/即時引き落とし）<br>4. 注文情報データベース登録 | 注文完了: **注文完了画面**へ遷移（注文番号を表示）<br>注文完了メールを送信。 | **エラーメッセージ**（例: 「クレジットカードの認証に失敗しました」「在庫が不足しています」）を画面上部に表示し、注文情報は登録しない。 |

-----

## 注文確定処理の詳細（バックエンド）

| ステップ | 処理内容 | 依存関係 | 成功時のアクション | 失敗時のアクション |
| :--- | :--- | :--- | :--- | :--- |
| **1. 最終データ検証** | サーバー側で全ての**必須項目**、**整合性**（例: ポイント利用上限）、**コードの有効性**を再確認。 | - | ステップ2へ。 | 処理停止、エラーコードを画面に返却。 |
| **2. 在庫確保** | 注文商品の数量を**在庫管理システム**で確認し、一時的に**引き当て（仮予約）を行う。 | ステップ1完了 | ステップ3へ。 | 処理停止、在庫不足エラーを画面に返却。引き当てはキャンセル。 |
| 3. 決済連携・実行 | 選択された決済方法に応じた決済代行会社**と通信し、決済を実行。<br>・クレジットカード: **オーソリゼーション（与信枠確保）**<br>・銀行振込/代金引換: **決済待ち**または**承認済み**として記録。 | ステップ2完了 | ステップ4へ。 | 処理停止、決済エラーを画面に返却。在庫引き当てを解除。 |
| **4. 注文情報DB登録** | 注文データ、配送データ、決済結果、利用ポイント、割引情報を**注文データベース**に永続的に保存し、**注文番号**を採番。 | ステップ3完了 | ステップ5へ。 | DBロールバック、決済取り消し、在庫引き当て解除。 |
| **5. ユーザー通知** | 注文番号を含む**注文完了メール**をユーザーへ即時送信。 | ステップ4完了 | 注文完了画面へリダイレクト。 | 注文処理は継続（メール送信失敗はソフトエラー）。 |

-----

## 関連する非機能要件

### セキュリティ

  * **クレジットカード情報**: サーバーで保持せず、すべて決済代行会社との間で**トークン決済**を利用する。
  * **通信**: 決済画面全体で**SSL/TLS**による暗号化通信（HTTPS）を必須とする。
  * **入力データ**: サーバーサイドで**サニタイジング**を行い、SQLインジェクションやクロスサイトスクリプティング（XSS）などの脆弱性を防止する。

### パフォーマンス

  * **注文確定処理**: 処理にかかる時間は**3秒以内**を目標とする（決済代行会社との通信時間を含む）。
  * **リアルタイム検証**: 入力時の遅延を感じさせないレスポンス速度を確保する。

### ユーザビリティ/アクセシビリティ

  * **フォーム**: モバイルフレンドリーなデザインとし、入力フィールドは**タップしやすいサイズ**と配置とする。
  * **エラー表示**: エラーメッセージは具体的で、**修正方法**を示す内容とする。

-----
